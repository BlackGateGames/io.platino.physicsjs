!function(t,e){"object"==typeof exports?module.exports=e.call(t):"function"==typeof define&&define.amd?define(function(){return e.call(t)}):t.Physics=e.call(t)}("undefined"!=typeof window?window:this,function(){"use strict";var t=function i(){return i.world.apply(i,arguments)};t.util={},function(){t.aabb=function(t,e,n,i){var o={x:0,y:0,hw:0,hh:0};return void 0===t?o:(t&&void 0!==t.x&&(n=e.x,i=e.y,e=t.y,t=t.x),void 0===i&&void 0!==t&&void 0!==e?(o.hw=.5*t,o.hh=.5*e,n&&void 0!==n.x&&(o.x=n.x,o.y=n.y),o):(o.hw=.5*Math.abs(n-t),o.hh=.5*Math.abs(i-e),o.x=.5*(n+t),o.y=.5*(i+e),o))},t.aabb.contains=function(t,e){return e.x>t.x-t.hw&&e.x<t.x+t.hw&&e.y>t.y-t.hh&&e.y<t.y+t.hh},t.aabb.clone=function(t){return{x:t.x,y:t.y,hw:t.hw,hh:t.hh}},t.aabb.union=function(t,e,n){var i=n===!0?t:{},o=Math.max(t.x+t.hw,e.x+e.hw),r=Math.max(t.y+t.hh,e.y+e.hh),s=Math.min(t.x-t.hw,e.x-e.hw),a=Math.min(t.y-t.hh,e.y-e.hh);return i.hw=.5*Math.abs(o-s),i.hh=.5*Math.abs(r-a),i.x=.5*(o+s),i.y=.5*(r+a),i},t.aabb.overlap=function(t,e){var n=t.x-t.hw,i=e.x-e.hw,o=t.x+t.hw,r=e.x+e.hw;return o>=i&&r>=o||r>=n&&o>=r?(n=t.y-t.hh,i=e.y-e.hh,o=t.y+t.hh,r=e.y+e.hh,o>=i&&r>=o||r>=n&&o>=r):!1}}(),function(){var e=1e-4,n=100,i=function(t,e,n){var i=e.normSq()-e.dot(t),o=e.dot(t)-t.normSq();return 0>i?n.clone(e).negate():o>0?n.clone(t).negate():(n.clone(e).vsub(t),n.perp(t.cross(n)>0))},o=function(e){var n,i,o=e.length,r=e[o-2],s=e[o-3],a=t.scratchpad(),c=a.vector().clone(r.pt),l=a.vector().clone(s.pt).vsub(c);return l.equals(t.vector.zero)?a.done({a:r.a,b:r.b}):(n=-l.dot(c)/l.normSq(),i=1-n,0>=i?a.done({a:s.a,b:s.b}):0>=n?a.done({a:r.a,b:r.b}):a.done({a:c.clone(r.a).mult(i).vadd(l.clone(s.a).mult(n)).values(),b:c.clone(r.b).mult(i).vadd(l.clone(s.b).mult(n)).values()}))},r=function(r,s,a,c){var l,h,u,d,p=!1,f=!1,v=!1,g=[],m=1,y=t.scratchpad(),b=y.vector().clone(s||t.vector.axis[0]),_=y.vector(),w=y.vector(),x=y.vector(),A=y.vector(),P=0;for(d=r(b),m=g.push(d),_.clone(d.pt),b.negate();++P;){if(_.swap(w),d=r(b),m=g.push(d),_.clone(d.pt),c&&c(g),_.equals(t.vector.zero)){p=!0;break}if(!f&&_.dot(b)<=0){if(a)break;f=!0}if(2===m)b=i(_,w,b);else if(f){if(b.normalize(),d=w.dot(b),Math.abs(d-_.dot(b))<e){v=-d;break}w.normSq()<x.clone(g[0].pt).normSq()?g.shift():g.splice(1,1),b=i(x.clone(g[1].pt),A.clone(g[0].pt),b)}else if(l=l||y.vector(),h=h||y.vector(),l.clone(w).vsub(_),h.clone(g[0].pt).vsub(_),u=l.cross(h)>0,u^_.cross(l)>0)g.shift(),l.perp(!u),b.swap(l);else{if(!(u^h.cross(_)>0)){p=!0;break}g.splice(1,1),h.perp(u),b.swap(l)}if(P>n)return y.done(),{simplex:g,iterations:P,distance:0,maxIterationsReached:!0}}return y.done(),d={overlap:p,simplex:g,iterations:P},v!==!1&&(d.distance=v,d.closest=o(g)),d};t.gjk=r}(),function(){t.statistics={pushRunningAvg:function(t,e,n,i){var o=t-n;return n+=o/e,i+=o*(t-n),[n,i]},pushRunningVectorAvg:function(t,e,n,i){var o=1/e,r=t.get(0)-n.get(0),s=t.get(1)-n.get(1);n.add(r*o,s*o),i&&(r*=t.get(0)-n.get(0),s*=t.get(1)-n.get(1),i.add(r,s))}}}(),function(){var e=function n(e,i,o){return this instanceof n?(this.v=new t.vector,this.o=new t.vector,e instanceof n?void this.clone(e):(e&&this.setTranslation(e),void this.setRotation(i||0,o))):new n(e,i)};e.prototype.setTranslation=function(t){return this.v.clone(t),this},e.prototype.setRotation=function(t,e){return this.cosA=Math.cos(t),this.sinA=Math.sin(t),e?this.o.clone(e):this.o.zero(),this},e.prototype.clone=function(t){return t?(this.setTranslation(t.v),this.cosA=t.cosA,this.sinA=t.sinA,this.o.clone(t.o),this):new e(this)},t.transform=e}(),function(e){var n=Math.sqrt,i=Math.min,o=Math.max,r=(Math.acos,Math.atan2),s=2*Math.PI,a=!!e.Float64Array,c=function l(t,e){return this instanceof l?(a?this._=new Float64Array(5):this._=[],void(t&&(void 0!==t.x||t._&&t._.length)?this.clone(t):(this.recalc=!0,this.set(t,e)))):new l(t,e)};Object.defineProperties(c.prototype,{x:{get:function(){return+this._[0]},set:function(t){t=+t||0,this.recalc=t===this._[0],this._[0]=t}},y:{get:function(){return+this._[1]},set:function(t){t=+t||0,this.recalc=t===this._[1],this._[1]=t}}}),c.prototype.set=function(t,e){return this.recalc=!0,this._[0]=+t||0,this._[1]=+e||0,this},c.prototype.get=function(t){return this._[t]},c.prototype.vadd=function(t){return this.recalc=!0,this._[0]+=t._[0],this._[1]+=t._[1],this},c.prototype.vsub=function(t){return this.recalc=!0,this._[0]-=t._[0],this._[1]-=t._[1],this},c.prototype.add=function(t,e){return this.recalc=!0,this._[0]+=+t||0,this._[1]+=+e||0,this},c.prototype.sub=function(t,e){return this.recalc=!0,this._[0]-=t,this._[1]-=void 0===e?0:e,this},c.prototype.mult=function(t){return this.recalc||(this._[4]*=t*t,this._[3]*=t),this._[0]*=t,this._[1]*=t,this},c.prototype.dot=function(t){return this._[0]*t._[0]+this._[1]*t._[1]},c.prototype.cross=function(t){return-this._[0]*t._[1]+this._[1]*t._[0]},c.prototype.proj=function(t){return this.dot(t)/t.norm()},c.prototype.vproj=function(t){var e=this.dot(t)/t.normSq();return this.clone(t).mult(e)},c.prototype.angle=function(t){var e;if(this.equals(c.zero))return t?t.angle():NaN;for(e=t&&!t.equals(c.zero)?r(this._[1]*t._[0]-this._[0]*t._[1],this._[0]*t._[0]+this._[1]*t._[1]):r(this._[1],this._[0]);e>Math.PI;)e-=s;for(;e<-Math.PI;)e+=s;return e},c.prototype.angle2=function(t,e){for(var n=t._[0]-this._[0],i=t._[1]-this._[1],o=e._[0]-this._[0],a=e._[1]-this._[1],c=r(i*o-n*a,n*o+i*a);c>Math.PI;)c-=s;for(;c<-Math.PI;)c+=s;return c},c.prototype.norm=function(){return this.recalc&&(this.recalc=!1,this._[4]=this._[0]*this._[0]+this._[1]*this._[1],this._[3]=n(this._[4])),this._[3]},c.prototype.normSq=function(){return this.recalc&&(this.recalc=!1,this._[4]=this._[0]*this._[0]+this._[1]*this._[1],this._[3]=n(this._[4])),this._[4]},c.prototype.dist=function(t){var e,i;return n((e=t._[0]-this._[0])*e+(i=t._[1]-this._[1])*i)},c.prototype.distSq=function(t){var e,n;return(e=t._[0]-this._[0])*e+(n=t._[1]-this._[1])*n},c.prototype.perp=function(t){var e=this._[0];return t?(this._[0]=this._[1],this._[1]=-e):(this._[0]=-this._[1],this._[1]=e),this},c.prototype.normalize=function(){var t=this.norm();return 0===t?this:(t=1/t,this._[0]*=t,this._[1]*=t,this._[3]=1,this._[4]=1,this)},c.prototype.transform=function(t){var e=t.sinA,n=t.cosA,i=t.o._[0],o=t.o._[1];return this._[0]-=i,this._[1]-=o,this.set(this._[0]*n-this._[1]*e+i+t.v._[0],this._[0]*e+this._[1]*n+o+t.v._[1])},c.prototype.transformInv=function(t){var e=t.sinA,n=t.cosA,i=t.o._[0],o=t.o._[1];return this._[0]-=i+t.v._[0],this._[1]-=o+t.v._[1],this.set(this._[0]*n+this._[1]*e+i,-this._[0]*e+this._[1]*n+o)},c.prototype.rotate=function(t,e){var n,i,o=0,r=0;return"number"==typeof t?(n=Math.sin(t),i=Math.cos(t),e&&(o=e.x,r=e.y)):(n=t.sinA,i=t.cosA,o=t.o._[0],r=t.o._[1]),this._[0]-=o,this._[1]-=r,this.set(this._[0]*i-this._[1]*n+o,this._[0]*n+this._[1]*i+r)},c.prototype.rotateInv=function(t){return this.set((this._[0]-t.o._[0])*t.cosA+(this._[1]-t.o._[1])*t.sinA+t.o._[0],-(this._[0]-t.o._[0])*t.sinA+(this._[1]-t.o._[1])*t.cosA+t.o._[1])},c.prototype.translate=function(t){return this.vadd(t.v)},c.prototype.translateInv=function(t){return this.vsub(t.v)},c.prototype.clone=function(t){return t?t._?(this.recalc=t.recalc,t.recalc||(this._[3]=t._[3],this._[4]=t._[4]),this._[0]=t._[0],this._[1]=t._[1],this):this.set(t.x,t.y):new c(this)},c.prototype.swap=function(t){var e=this._;return this._=t._,t._=e,e=this.recalc,this.recalc=t.recalc,t.recalc=e,this},c.prototype.values=function(){return{x:this._[0],y:this._[1]}},c.prototype.zero=function(){return this._[3]=0,this._[4]=0,this._[0]=0,this._[1]=0,this},c.prototype.negate=function(t){return void 0!==t?(this._[t]=-this._[t],this):(this._[0]=-this._[0],this._[1]=-this._[1],this)},c.prototype.clamp=function(t,e){return this._[0]=i(o(this._[0],t.x),e.x),this._[1]=i(o(this._[1],t.y),e.y),this.recalc=!0,this},c.prototype.toString=function(){return"("+this._[0]+", "+this._[1]+")"},c.prototype.equals=function(t){return this._[0]===t._[0]&&this._[1]===t._[1]&&this._[2]===t._[2]},c.axis=[new c(1,0),new c(0,1)],c.zero=new c(0,0),t.vector=c}(this),function(e){var n=e.Physics;t.noConflict=function(){return e.Physics===t&&(e.Physics=n),t}}(this);var e=t.util.decorator=function(e,n){var i={},o={},r=function(e,n){var i,o;for(o in n)i=Object.getOwnPropertyDescriptor(n,o),i.get||i.set?Object.defineProperty(e,o,i):t.util.isFunction(i.value)&&(e[o]=i.value);return e},s=Object.getPrototypeOf;"function"!=typeof s&&(s="object"==typeof"test".__proto__?function(t){return t.__proto__}:function(t){return t.constructor.prototype});var a=Object.create;"function"!=typeof a&&(a=function(t){function e(){}return e.prototype=t,new e});var c=function(n,i){return"object"==typeof n?(o=r(o,n),void(o.type=e)):void("type"!==n&&t.util.isFunction(i)&&(o[n]=i))};c(n);var l=function(t,n,c,l){var h,u=o;if("string"!=typeof n)l=c,c=n;else{if(u=i[n],!u)throw'Error: "'+n+'" '+e+" not defined";u=u.prototype}if("function"==typeof c)h=i[t],h?h.prototype=r(h.prototype,c(s(h.prototype))):(h=i[t]=function(t){this.init&&this.init(t)},h.prototype=a(u),h.prototype=r(h.prototype,c(u,h.prototype))),h.prototype.type=e,h.prototype.name=t;else if(l=c||{},h=i[t],!h)throw'Error: "'+t+'" '+e+" not defined";return l?new h(l):void 0};return l.mixin=c,l};t.util.indexOf=function(t,e){for(var n=0,i=t.length;i>n;){if(i--,t[n]===e)return n;if(t[i]===e)return i;n++}return-1},t.util.clearArray=function(t){for(var e=t.length;e--;)t.pop();return t},t.util.throttle=function(t,e,n){var i,o,r=!1,s=function(){clearTimeout(i),r?(r=!1,i=setTimeout(s,e),t.apply(n,o)):i=!1};return n=n||null,function(){r=!0,o=arguments,i||s()}};var n=function(e,i){return t.util.isPlainObject(i)?t.util.extend({},e,i,n):void 0!==i?i:e};return t.util.options=function(e,i){var o,r={},s=[];return o=function(e,o){t.util.extend(i,e,o?n:null);for(var r=0,a=s.length;a>r;++r)s[r](i);return i},o.defaults=function(e,o){return t.util.extend(r,e,o?n:null),t.util.defaults(i,r,o?n:null),r},o.onChange=function(t){s.push(t)},i=i||o,o.defaults(e),o},t.util.pairHash=function(t,e){return t=0|t,e=0|e,(0|t)===(0|e)?-1:0|((0|t)>(0|e)?t<<16|65535&e:e<<16|65535&t)},Function.prototype.bind?t.util.bind=function(t,e,n){return n=Array.prototype.slice.call(arguments,1),Function.prototype.bind.apply(t,n)}:t.util.bind=function(t,e,n){return n=Array.prototype.slice.call(arguments,2),function(){return t.apply(e,n.concat(Array.prototype.slice.call(arguments)))}},t.util.find=function(t,e){var n,i,o=t.length;for(n=0;o>n;n++)if(i=t[n],e(i,n,t))return i},t.util.filter=function(t,e){var n,i,o=t.length,r=[];for(n=0;o>n;n++)i=t[n],e(i,n,t)&&r.push(i);return r},function(){function e(e){t.util.clearArray(e),w.length<A&&w.push(e)}function n(t){var e=t.cache;e&&n(e),t.array=t.cache=t.criteria=t.object=t.number=t.string=t.value=null,x.length<A&&x.push(t)}function i(){return x.pop()||{array:null,cache:null,criteria:null,"false":!1,index:0,"null":!1,number:null,object:null,push:null,string:null,"true":!1,undefined:!1,value:null}}function o(){return w.pop()||[]}function r(e,n){var i=typeof n;if(e=e.cache,"boolean"===i||null==n)return e[n]?0:-1;"number"!==i&&"string"!==i&&(i="object");var o="number"===i?n:P+n;return e=(e=e[i])&&e[o],"object"===i?e&&t.util.indexOf(e,n)>-1?0:-1:e?0:-1}function s(t){var e=this.cache,n=typeof t;if("boolean"===n||null==t)e[t]=!0;else{"number"!==n&&"string"!==n&&(n="object");var i="number"===n?t:P+t,o=e[n]||(e[n]={});"object"===n?(o[i]||(o[i]=[])).push(t):o[i]=!0}}function a(t){var e=-1,n=t.length,o=t[0],r=t[n/2|0],a=t[n-1];if(o&&"object"==typeof o&&r&&"object"==typeof r&&a&&"object"==typeof a)return!1;var c=i();c["false"]=c["null"]=c["true"]=c.undefined=!1;var l=i();for(l.array=t,l.cache=c,l.push=s;++e<n;)l.push(t[e]);return l}function c(t,e){return t+Math.floor(Math.random()*(e-t+1))}function l(t){return"function"==typeof t}function h(t){return"function"==typeof t&&T.test(t)}function u(t){var e,n;if(!t||y.call(t)!==g||(e=t.constructor,l(e)&&!(e instanceof e)))return!1;for(var i in t)n=i;return"undefined"==typeof n||b.call(t,n)}function d(i,s,c){var l=-1,h=t.util.indexOf,u=i?i.length:0,d=[],p=!s&&u>=_&&h===t.util.indexOf,f=c||p?o():d;if(p){var v=a(f);h=r,f=v}for(;++l<u;){var g=i[l],m=c?c(g,l,i):g;(s?!l||f[f.length-1]!==m:h(f,m)<0)&&((c||p)&&f.push(m),d.push(g))}return p?(e(f.array),n(f)):c&&e(f),d}var p={"boolean":!1,"function":!0,object:!0,number:!1,string:!1,undefined:!1},f=function(t){return t},v="[object Array]",g="[object Object]",m=Object.keys,y=Object.prototype.toString,b=Object.prototype.hasOwnProperty,_=75,w=[],x=[],A=40,P=+new Date+"",C=function(t){var e,n=t,i=[];if(!n)return i;if(!p[typeof t])return i;for(e in n)b.call(n,e)&&i.push(e);return i},B=m?function(e){return t.util.isObject(e)?m(e):[]}:C,k=0;t.util.uniqueId=function(t){var e=++k;return""+(t||"")+e},t.util.shuffle=function(t){var e,n,i,o,r=-1,s=t?t.length:0,a=Array("number"==typeof s?s:0);for(e=0,n=t.length;n>e;e++)i=t[e],o=c(0,++r),a[r]=a[o],a[o]=i;return a},t.util.isObject=function(t){return!(!t||!p[typeof t])},t.util.isFunction=l,t.util.isArray=Array.isArray||function(t){return t&&"object"==typeof t&&"number"==typeof t.length&&y.call(t)===v||!1};var T=RegExp("^"+String(y).replace(/[.*+?^${}()|[\]\\]/g,"\\$&").replace(/toString| for [^\]]+/g,".*?")+"$");t.util.isPlainObject=Object.getPrototypeOf?function(t){if(!t||y.call(t)!==g)return!1;var e=t.valueOf,n=h(e)&&(n=Object.getPrototypeOf(e))&&Object.getPrototypeOf(n);return n?t===n||Object.getPrototypeOf(t)===n:u(t)}:u,t.util.uniq=function(t,e,n){return"boolean"!=typeof e&&null!=e&&(n=e,e=!1),d(t,e,n)};var M=function(t,e,n){var i,o=t,r=o;if(!o)return r;var s,a=arguments,c=0,l="number"==typeof n?2:a.length;for(l>2&&"function"==typeof a[l-1]&&(s=a[--l]);++c<l;)if(o=a[c],o&&p[typeof o])for(var h=-1,u=p[typeof o]&&B(o),d=u?u.length:0;++h<d;)i=u[h],r[i]=s?s(r[i],o[i]):o[i];return r};t.util.extend=M,t.util.defaults=function(t,e,n){var i,o=t,r=o;if(!o)return r;for(var s=arguments,a=0,c="number"==typeof n?2:s.length;++a<c;)if(o=s[a],o&&p[typeof o])for(var l=-1,h=p[typeof o]&&B(o),u=h?h.length:0;++l<u;)i=h[l],"undefined"==typeof r[i]&&(r[i]=o[i]);return r},t.util.sortedIndex=function(t,e,n){var i=0,o=t?t.length:i;for(n=n||f,e=n(e);o>i;){var r=i+o>>>1;n(t[r])<e?i=r+1:o=r}return i}}(),t.scratchpad=function(){var e,n,i="Error: Scratchpad used after .done() called. (Could it be unintentionally scoped?)",o="Error: Scratchpad usage space out of bounds. (Did you forget to call .done()?)",r="Error: Too many scratchpads created. (Did you forget to call .done()?)",s="Error: Object is already registered.",a=[],c=0,l=0;return e=function(){if(this._active=!1,this._indexArr=[],++c>=n.maxScratches)throw r},e.prototype={done:function(t){this._active=!1;for(var e=0;l>e;++e)this[e]=0;return a.push(this),t}},n=function h(t){if(t)return h.fn(t);var n=a.pop()||new e;return n._active=!0,n},n.maxScratches=100,n.maxIndex=20,n.fn=function(t){for(var n=[],i=0,o=t.length;o>i;i++)n.push(i);n="a"+n.join(",a");var r=new Function("fn, scratches, Scratch","return function("+n+"){ var scratch = scratches.pop() || new Scratch( scratches );scratch._active = true;return scratch.done( fn(scratch, "+n+") );};");return r(t,a,e)},n.register=function(t,r,a){var c=e.prototype,h=l++,u="_"+t+"Stack",d=a&&a.useFactory;if(t in c)throw s;e.prototype[t]=function(){var t=this[u]||(this[u]=[]),e=0|this[h];if(this[h]=e+1,!this._active)throw i;if(e>=n.maxIndex)throw o;return t[e]||(t[e]=d?r():new r)}},n.register("vector",t.vector),n.register("transform",t.transform),n}(),function(){function e(t){return t._priority_}var n=1;t.scratchpad.register("event",function(){return{}},{useFactory:!0});var i=function o(){return this instanceof o?void 0:new o};i.prototype={on:function(i,o,r,s){var a,c,l;if(this._topics=this._topics||(this._topics={}),t.util.isObject(i)){for(var h in i)this.on(h,i[h],o,r);return this}return a=this._topics[i]||(this._topics[i]=[]),c=o,t.util.isObject(r)?(o=t.util.bind(o,r),o._bindfn_=c,o._one_=c._one_,o._scope_=r):void 0===s&&(s=r),o._priority_=void 0===s?n:s,l=t.util.sortedIndex(a,o,e),a.splice(l,0,o),this},off:function(e,n,i){var o,r;if(!this._topics)return this;if(e===!0)return this._topics={},this;if(t.util.isObject(e)){for(var s in e)this.off(s,e[s]);return this}if(o=this._topics[e],!o)return this;if(n===!0)return this._topics[e]=[],this;for(var a=0,c=o.length;c>a;a++)if(r=o[a],!(r._bindfn_!==n&&r!==n||i&&r._scope_!==i)){o.splice(a,1);break}return this},emit:function(e,n){if(!this._topics)return this;var i,o,r=this._topics[e],s=r&&r.length,a=t.scratchpad();if(!s)return a.done(this);for(o=a.event(),o.topic=e,o.handler=i;s--;)i=r[s],i(n,o),i._one_&&r.splice(s,1);return a.done(this)},one:function(e,n,i){if(t.util.isObject(e)){for(var o in e)this.one(o,e[o],n,i);return this}return n._one_=!0,this.on(e,n,i),this}},t.util.pubsub=i}(),function(e){var n=function(){return!0},i=t.util.indexOf,o=function(t,e){return function(n){return t(n[e])}},r=function(e,n){return function(o){o=n?o[n]:o;var r,s=0;if(t.util.isArray(o)){if(t.util.isArray(e)){if(r=o.length,r!==e.length)return!1;for(;r>s;){if(r--,-1===i(e,o[s])||-1===i(e,o[r]))return!1;s++}return!0}return i(o,e)>-1}return o===e}},s=function(t,e){var n=r(t,e);return function(t){return!n(t)}},a=function(e,n){return function(o){o=n?o[n]:o;var r,s=0;if(t.util.isArray(o)){for(r=o.length;r>s;){if(r--,i(e,o[s])>-1||i(e,o[r])>-1)return!0;s++}return!1}return i(e,o)>-1}},c=function(t,e){var n=a(t,e);return function(t){return!n(t)}},l=function(e){return e=new t.vector(e),function(n){var i=n.aabb();return t.aabb.contains(i,e)}},h=function(t){return t.next?function(e){for(var n=t;n;){if(!n(e))return!1;n=n.next}return!0}:t},u=function(t){return t.next?function(e){for(var n=t;n;){if(n(e))return!0;n=n.next}return!1}:t},d={$eq:r,$ne:s,$in:a,$nin:c,$at:l},p=function f(e,i){var s,a,c,l,p,v;if(i){if("$or"===i||"$and"===i){for(s=0,a=e.length;a>s;++s)v=f(e[s]),p=p?p.next=v:l=v;return"$or"===i?u(l):h(l)}if(s=d[i])return s(e);throw"Unknown query operation: "+i}for(s in e)c=e[s],v="$"===s[0]?f(c,s):t.util.isPlainObject(c)?o(f(c),s):r(c,s),p=p?p.next=v:l=v;return h(l||n)};t.query=p}(this),function(){var n={priority:0};t.behavior=e("behavior",{init:function(e){this.options=t.util.options(n),this.options(e)},applyTo:function(e){return e===!0?this._targets=null:this._targets=t.util.uniq(e),this},getTargets:function(){return this._targets||(this._world?this._world._bodies:[])},setWorld:function(t){return this.disconnect&&this._world&&this.disconnect(this._world),this._world=t,this.connect&&t&&this.connect(t),this},connect:function(t){this.behave&&t.on("integrate:positions",this.behave,this,this.options.priority)},disconnect:function(t){this.behave&&t.off("integrate:positions",this.behave,this)},behave:null})}(),function(){var n={hidden:!1,treatment:"dynamic",mass:1,restitution:1,cof:.8,view:null},i=1;2*Math.PI;t.body=e("body",{init:function(e){var o=this,r=t.vector;if(this.options=t.util.options(n,this),this.options.onChange(function(t){o.offset=new r(t.offset)}),this.options(e),this.sprite=null,this.state={pos:new r(this.x,this.y),vel:new r(this.vx,this.vy),acc:new r,angular:{pos:this.angle||0,vel:this.angularVelocity||0,acc:0},old:{pos:new r,vel:new r,acc:new r,angular:{pos:0,vel:0,acc:0}}},this._sleepAngPosMean=0,this._sleepAngPosVariance=0,this._sleepPosMean=new r,this._sleepPosVariance=new r,this._sleepMeanK=0,delete this.x,delete this.y,delete this.vx,delete this.vy,delete this.angle,delete this.angularVelocity,0===this.mass)throw"Error: Bodies must have non-zero mass";this.uid=i++,this.geometry=t.geometry("point")},sleep:function(t){return t===!0?this.asleep=!0:t===!1?(this.asleep=!1,this._sleepMeanK=0,this._sleepAngPosMean=0,this._sleepAngPosVariance=0,this._sleepPosMean.zero(),this._sleepPosVariance.zero(),this.sleepIdleTime=0):t&&!this.asleep&&this.sleepCheck(t),this.asleep},sleepCheck:function(e){var n=this._world&&this._world.options;if(!(this.sleepDisabled||n&&n.sleepDisabled)){var i,o,r,s,a,c,l=t.scratchpad();l.vector(),l.vector();if(e=e||0,s=this.geometry.aabb(),r=Math.max(s.hw,s.hh),this.asleep&&(o=this.state.vel.norm()+Math.abs(r*this.state.angular.vel),i=this.sleepSpeedLimit||n&&n.sleepSpeedLimit||0,o>=i))return this.sleep(!1),l.done();this._sleepMeanK++,a=this._sleepMeanK>1?1/(this._sleepMeanK-1):0,t.statistics.pushRunningVectorAvg(this.state.pos,this._sleepMeanK,this._sleepPosMean,this._sleepPosVariance),c=t.statistics.pushRunningAvg(Math.sin(this.state.angular.pos),this._sleepMeanK,this._sleepAngPosMean,this._sleepAngPosVariance),this._sleepAngPosMean=c[0],this._sleepAngPosVariance=c[1],o=this._sleepPosVariance.norm()+Math.abs(r*Math.asin(c[1])),o*=a,i=this.sleepVarianceLimit||n&&n.sleepVarianceLimit||0,i>=o?(i=this.sleepTimeLimit||n&&n.sleepTimeLimit||0,this.sleepIdleTime=(this.sleepIdleTime||0)+e,this.sleepIdleTime>i&&(this.asleep=!0)):this.sleep(!1),l.done()}},updateSprite:function(){return this.sprite&&(this.sprite.centerX=this.state.pos.x,this.sprite.centerY=this.state.pos.y,this.sprite.rotate(this.state.angular.pos*(180/Math.PI))),this},setWorld:function(t){this._world&&(this._world.off("step",this.updateSprite),this.disconnect&&this.disconnect(this._world)),this._world=t,this._world&&(this._world.on("step",this.updateSprite,this),this.connect&&this.connect(this._world))},accelerate:function(t){return"dynamic"===this.treatment&&this.state.acc.vadd(t),this},applyForce:function(e,n){if("dynamic"!==this.treatment)return this;var i,o=t.scratchpad(),r=o.vector();return n&&this.moi&&(i=this.state,r.clone(n),this.state.angular.acc-=r.cross(e)/this.moi),this.accelerate(r.clone(e).mult(1/this.mass)),o.done(),this},getGlobalOffset:function(e){return e=e||new t.vector,e.clone(this.offset).rotate(this.state.angular.pos),e},aabb:function(){var e=this.state.angular.pos,n=t.scratchpad(),i=n.vector(),o=this.geometry.aabb(e);return this.getGlobalOffset(i),o.x+=this.state.pos._[0]+i._[0],o.y+=this.state.pos._[1]+i._[1],n.done(o)},toBodyCoords:function(t){return t.vsub(this.state.pos).rotate(-this.state.angular.pos)},toWorldCoords:function(t){return t.rotate(this.state.angular.pos).vadd(this.state.pos)},recalc:function(){return this}}),t.body.getCOM=function(e,n){var i,o,r,s=e&&e.length,a=0;if(n=n||new t.vector,!s)return n.zero();if(1===s)return n.clone(e[0].state.pos);for(n.zero(),r=0;s>r;r++)i=e[r],o=i.state.pos,n.add(o._[0]*i.mass,o._[1]*i.mass),a+=i.mass;return n.mult(1/a),n}}(),function(){t.geometry=e("geometry",{init:function(e){this.options=t.util.options(),this.options(e),this._aabb=new t.aabb},aabb:function(e){return t.aabb.clone(this._aabb)},getFarthestHullPoint:function(e,n){return n=n||new t.vector,n.set(0,0)},getFarthestCorePoint:function(e,n,i){return n=n||new t.vector,n.set(0,0)}})}(),t.geometry.regularPolygonVertices=function(t,e){var n,i=[],o=2*Math.PI/t,r=0;for(n=0;t>n;n++)i.push({x:e*Math.cos(r),y:e*Math.sin(r)}),r+=o;return i},t.geometry.isPolygonConvex=function(e){var n=t.scratchpad(),i=n.vector(),o=n.vector(),r=n.vector(),s=!0,a=!1,c=e.length;if(!e||!c)return!1;if(3>c)return n.done(),s;i.clone(e[0]).vsub(r.clone(e[c-1]));for(var l=1;c>=l;++l){if(o.clone(e[l%c]).vsub(r.clone(e[(l-1)%c])),a===!1)a=i.cross(o);else if(a>0^i.cross(o)>0){s=!1;break}o.swap(i)}return n.done(),s},t.geometry.getPolygonMOI=function(e){var n,i=t.scratchpad(),o=i.vector(),r=i.vector(),s=0,a=0,c=e.length;if(2>c)return i.done(),0;if(2===c)return n=r.clone(e[1]).distSq(o.clone(e[0])),i.done(),n/12;o.clone(e[0]);for(var l=1;c>l;++l)r.clone(e[l]),n=Math.abs(r.cross(o)),s+=n*(r.normSq()+r.dot(o)+o.normSq()),a+=n,o.swap(r);return i.done(),s/(6*a)},t.geometry.isPointInPolygon=function(e,n){var i=t.scratchpad(),o=i.vector().clone(e),r=i.vector(),s=i.vector(),a=0,c=n.length;if(2>c)return a=o.equals(r.clone(n[0])),i.done(),a;if(2===c)return a=o.angle(r.clone(n[0])),a+=o.angle(r.clone(n[1])),i.done(),Math.abs(a)===Math.PI;r.clone(n[0]).vsub(o);for(var l=1;c>=l;++l)s.clone(n[l%c]).vsub(o),a+=s.angle(r),r.swap(s);return i.done(),Math.abs(a)>1e-6},t.geometry.getPolygonArea=function(e){var n=t.scratchpad(),i=n.vector(),o=n.vector(),r=0,s=e.length;if(3>s)return n.done(),0;i.clone(e[s-1]);for(var a=0;s>a;++a)o.clone(e[a]),r+=i.cross(o),i.swap(o);return n.done(),r/2},t.geometry.getPolygonCentroid=function(e){var n,i=t.scratchpad(),o=i.vector(),r=i.vector(),s=new t.vector,a=e.length;if(2>a)return i.done(),new t.vector(e[0]);if(2===a)return i.done(),new t.vector((e[1].x+e[0].x)/2,(e[1].y+e[0].y)/2);o.clone(e[a-1]);for(var c=0;a>c;++c)r.clone(e[c]),n=o.cross(r),o.vadd(r).mult(n),s.vadd(o),o.swap(r);return n=1/(6*t.geometry.getPolygonArea(e)),i.done(),s.mult(n)},t.geometry.nearestPointOnLine=function(e,n,i){var o,r,s=t.scratchpad(),a=s.vector().clone(e),c=s.vector().clone(n).vsub(a),l=s.vector().clone(i).vsub(a).vsub(c);return l.equals(t.vector.zero)?(s.done(),new t.vector(n)):(o=-l.dot(c)/l.normSq(),r=1-o,0>=r?(s.done(),new t.vector(i)):0>=o?(s.done(),new t.vector(n)):(a=new t.vector(i).mult(o).vadd(c.clone(n).mult(r)),s.done(),a))},function(){var n={drag:0};t.integrator=e("integrator",{init:function(e){this.options=t.util.options(n),this.options(e)},setWorld:function(t){return this.disconnect&&this._world&&this.disconnect(this._world),this._world=t,this.connect&&t&&this.connect(t),this},integrate:function(t,e){var n=this._world;return this.integrateVelocities(t,e),n&&n.emit("integrate:velocities",{bodies:t,dt:e}),this.integratePositions(t,e),n&&n.emit("integrate:positions",{bodies:t,dt:e}),this},connect:null,disconnect:null,integrateVelocities:function(t,e){throw"The integrator.integrateVelocities() method must be overriden"},integratePositions:function(t,e){throw"The integrator.integratePositions() method must be overriden"}})}(),function(){var e=function o(t,e,n){for(var i,r,s=function(){return o(t,e,n)};i=t.shift();)if(r=i.apply(e,n),r&&r.then)return r.then(s)},n={timestep:6,maxIPF:4,webworker:!1,integrator:"verlet",sleepDisabled:!1,sleepSpeedLimit:.05,sleepVarianceLimit:.02,sleepTimeLimit:500},i=function r(t,e){return this instanceof r?void this.init(t,e):new r(t,e)};i.prototype=t.util.extend({},t.util.pubsub.prototype,{init:function(i,o){var r=this;(t.util.isFunction(i)||t.util.isArray(i))&&(o=i,i={}),this._meta={fps:0,ipf:0},this._bodies=[],this._behaviors=[],this._integrator=null,this._renderer=null,this._paused=!1,this._warp=1,this._time=0,this.options=t.util.options(n),this.options.onChange(function(t){r.timestep(t.timestep)}),this.options(i),this.add(t.integrator(this.options.integrator)),t.util.isFunction(o)?e([o],this,[this,t]):t.util.isArray(o)&&e(o,this,[this,t])},options:null,add:function(e){var n=0,i=e&&e.length||0,o=t.util.isArray(e)?e[0]:e;if(!o)return this;do switch(o.type){case"behavior":this.addBehavior(o);break;case"integrator":this.integrator(o);break;case"body":this.addBody(o);break;default:throw'Error: failed to add item of unknown type "'+o.type+'" to world'}while(++n<i&&(o=e[n]));return this},remove:function(e){var n=0,i=e&&e.length||0,o=t.util.isArray(e)?e[0]:e;if(!o)return this;do switch(o.type){case"behavior":this.removeBehavior(o);break;case"integrator":o===this._integrator&&this.integrator(null);break;case"body":this.removeBody(o);break;default:throw'Error: failed to remove item of unknown type "'+o.type+'" from world'}while(++n<i&&(o=e[n]));return this},has:function(e){var n;if(!e)return!1;switch(e.type){case"behavior":n=this._behaviors;break;case"integrator":return this._integrator===e;case"body":n=this._bodies;break;default:throw'Error: unknown type "'+e.type+'"'}return t.util.indexOf(n,e)>-1},integrator:function(t){return void 0===t?this._integrator:this._integrator===t?this:(this._integrator&&(this._integrator.setWorld(null),this.emit("remove:integrator",{integrator:this._integrator})),t&&(this._integrator=t,this._integrator.setWorld(this),this.emit("add:integrator",{integrator:this._integrator})),this)},timestep:function(t){return t?(this._dt=+t.toPrecision(4),this._maxJump=t*this.options.maxIPF,this):this._dt},wakeUpAll:function(){var t=0,e=this._bodies.length;for(t=0;e>t;t++)this._bodies[t].sleep(!1)},addBehavior:function(t){return this.has(t)?this:(t.setWorld(this),this._behaviors.push(t),this.emit("add:behavior",{behavior:t}),this)},getBehaviors:function(){return[].concat(this._behaviors)},removeBehavior:function(t){var e=this._behaviors;if(t)for(var n=0,i=e.length;i>n;++n)if(t===e[n]){e.splice(n,1),t.setWorld(null),this.emit("remove:behavior",{behavior:t});break}return this},addBody:function(t){return this.has(t)?this:(t.setWorld(this),this._bodies.push(t),this.emit("add:body",{body:t}),this)},getBodies:function(){return[].concat(this._bodies)},removeBody:function(t){var e=this._bodies;if(t)for(var n=0,i=e.length;i>n;++n)if(t===e[n]){e.splice(n,1),t.setWorld(null),this.emit("remove:body",{body:t});break}return this},findOne:function(e){var n=this,i="function"==typeof e?e:t.query(e);return t.util.find(n._bodies,i)||!1},find:function(e){var n=this,i="function"==typeof e?e:t.query(e);return t.util.filter(n._bodies,i)},iterate:function(t){this._integrator.integrate(this._bodies,t)},stepDelta:function(t){return(this._paused||void 0===this._animTime)&&(this._animTime=this._animTime||new Date),this._paused?this:this.step(this._animTime.valueOf()+t)},step:function(t){var e,n,i,o=this._time,r=this._warp,s=1/r,a=this._dt,c=a*s,l=this._maxJump*s,h=this._meta;if(this._paused||void 0===this._animTime)return this._animTime=t||this._animTime||new Date,this._paused||this.emit("step",h),this;if(t=t||this._animTime+c,e=t-this._animTime,e>l&&(this._animTime=t-l,e=l),n=e*r,i=o+n-a,this.emit("beforeStep"),i>=o)for(;i>=o;)o+=a,this._animTime+=c,this._time=o,this.iterate(a);return h.fps=1e3/(t-this._lastTime),h.ipf=(n/a).toFixed(2),h.interpolateTime=a+i-o,this._lastTime=t,this.emit("step",h),this},warp:function(t){return void 0===t?this._warp:(this._warp=t||1,this)},pause:function(){return this._paused=!0,this.emit("pause"),this},unpause:function(){return this._paused=!1,this.emit("unpause"),this},isPaused:function(){return!!this._paused},destroy:function(){var t=this;t.pause(),this.emit("destroy"),t.off(!0),t.remove(t.getBodies()),t.remove(t.getBehaviors()),t.integrator(null)}}),t.world=i}(),t.integrator("verlet",function(e){return t.body.mixin({started:function(t){return void 0!==t&&(this._started=!0),!!this._started}}),{init:function(t){e.init.call(this,t)},integrateVelocities:function(t,e){for(var n,i=e*e,o=1-this.options.drag,r=null,s=this.prevDt||e,a=.5*(i+e*s),c=0,l=t.length;l>c;++c)r=t[c],n=r.state,"static"===r.treatment||r.sleep(e)?(n.vel.zero(),n.acc.zero(),n.angular.vel=0,n.angular.acc=0):(n.vel.equals(n.old.vel)&&r.started()?n.vel.clone(n.pos).vsub(n.old.pos):(n.old.pos.clone(n.pos).vsub(n.vel),n.vel.mult(e)),o&&n.vel.mult(o),n.vel.vadd(n.acc.mult(a)),n.vel.mult(1/e),n.old.vel.clone(n.vel),n.acc.zero(),n.angular.vel===n.old.angular.vel&&r.started()?n.angular.vel=n.angular.pos-n.old.angular.pos:(n.old.angular.pos=n.angular.pos-n.angular.vel,n.angular.vel*=e),n.angular.vel+=n.angular.acc*a,n.angular.vel/=e,n.old.angular.vel=n.angular.vel,n.angular.acc=0,r.started(!0))},integratePositions:function(t,e){for(var n,i=null,o=this.prevDt||e,r=e/o,s=0,a=t.length;a>s;++s)i=t[s],n=i.state,"static"===i.treatment||i.sleep()||(n.vel.mult(e*r),n.old.pos.clone(n.pos),n.pos.vadd(n.vel),n.vel.mult(1/(e*r)),n.old.vel.clone(n.vel),n.angular.vel*=e*r,n.old.angular.pos=n.angular.pos,n.angular.pos+=n.angular.vel,n.angular.vel/=e*r,n.old.angular.vel=n.angular.vel);this.prevDt=e}}}),t.geometry("point",function(t){}),t.body("point",function(t){return{init:function(e){t.init.call(this,e),this.moi=0}}}),t.geometry("circle",function(e){var n={radius:1};return{init:function(i){e.init.call(this,i),this.options.defaults(n),this.options.onChange(function(t){this.radius=t.radius}),this.options(i),this._aabb=t.aabb(),this.radius=this.options.radius},aabb:function(e){var n=this.radius;return this._aabb.hw!==n&&(this._aabb=t.aabb(-n,-n,n,n)),t.aabb.clone(this._aabb)},getFarthestHullPoint:function(e,n){return n=n||new t.vector,n.clone(e).normalize().mult(this.radius)},getFarthestCorePoint:function(e,n,i){
return n=n||new t.vector,n.clone(e).normalize().mult(this.radius-i)}}}),t.geometry("compound",function(e){var n={};return{init:function(t){e.init.call(this,t),this.options.defaults(n),this.options(t),this.children=[]},addChild:function(e,n,i){return this._aabb=null,this.children.push({g:e,pos:new t.vector(n),angle:i}),this},clear:function(){return this._aabb=null,this.children=[],this},aabb:function(e){if(!e&&this._aabb)return t.aabb.clone(this._aabb);var n,i,o,r=t.scratchpad(),s=t.vector();e=e||0;for(var a=0,c=this.children.length;c>a;a++)i=this.children[a],n=i.g.aabb(e+i.angle),s.clone(i.pos),e&&s.rotate(e),n.x+=s._[0],n.y+=s._[1],o=o?t.aabb.union(o,n,!0):n;return e||(this._aabb=t.aabb.clone(o)),r.done(o)},getFarthestHullPoint:function(e,n){var i,o,r=this.children.length,s=t.scratchpad(),a=s.vector(),c=0,l=0;for(n=n||new t.vector,o=0;r>o;o++)i=this.children[o],i.g.getFarthestHullPoint(e.rotate(-i.angle),a),c=a.rotate(i.angle).vadd(i.pos).proj(e.rotate(i.angle)),c>l&&(l=c,n.swap(a));return s.done(n)},getFarthestCorePoint:function(e,n,i){var o,r,s=this.children.length,a=t.scratchpad(),c=a.vector(),l=0,h=0;for(n=n||new t.vector,r=0;s>r;r++)o=this.children[r],o.g.getFarthestCorePoint(e.rotate(-o.angle),c,i),l=c.rotate(o.angle).vadd(o.pos).proj(e.rotate(o.angle)),l>h&&(h=l,n.swap(c));return a.done(n)}}}),t.geometry("convex-polygon",function(e){var n="Error: The vertices specified do not match that of a _convex_ polygon.",i={};return{init:function(t){var n=this;e.init.call(this,t),this.options.defaults(i),this.options.onChange(function(t){n.setVertices(t.vertices||[])}),this.options(t),n.setVertices(this.options.vertices||[])},setVertices:function(e){var i=t.scratchpad(),o=i.transform(),r=this.vertices=[];if(!t.geometry.isPolygonConvex(e))throw n;o.setRotation(0),o.setTranslation(t.geometry.getPolygonCentroid(e).negate());for(var s=0,a=e.length;a>s;++s)r.push(new t.vector(e[s]).translate(o));return this._area=t.geometry.getPolygonArea(r),this._aabb=!1,i.done(this)},aabb:function(e){if(!e&&this._aabb)return t.aabb.clone(this._aabb);var n,i=t.scratchpad(),o=i.vector(),r=i.transform().setRotation(e||0),s=i.vector().set(1,0).rotateInv(r),a=i.vector().set(0,1).rotateInv(r),c=this.getFarthestHullPoint(s,o).proj(s),l=-this.getFarthestHullPoint(s.negate(),o).proj(s),h=this.getFarthestHullPoint(a,o).proj(a),u=-this.getFarthestHullPoint(a.negate(),o).proj(a);return n=t.aabb(l,u,c,h),e||(this._aabb=t.aabb.clone(n)),i.done(),n},getFarthestHullPoint:function(e,n,i){var o,r,s,a=this.vertices,c=a.length,l=2;if(n=n||new t.vector,2>c)return i&&(i.idx=0),n.clone(a[0]);if(r=a[0].dot(e),o=a[1].dot(e),2===c)return s=o>=r?1:0,i&&(i.idx=s),n.clone(a[s]);if(o>=r){for(;c>l&&o>=r;)r=o,o=a[l].dot(e),l++;return o>=r&&l++,s=l-2,i&&(i.idx=l-2),n.clone(a[s])}for(l=c;l>1&&r>=o;)l--,o=r,r=a[l].dot(e);return s=(l+1)%c,i&&(i.idx=s),n.clone(a[s])},getFarthestCorePoint:function(e,n,i){var o,r=t.scratchpad(),s=r.vector(),a=r.vector(),c=this.vertices,l=c.length,h=this._area>0,u={};return n=this.getFarthestHullPoint(e,n,u),s.clone(c[(u.idx+1)%l]).vsub(n).normalize().perp(h),a.clone(c[(u.idx-1+l)%l]).vsub(n).normalize().perp(!h),o=i/(1+s.dot(a)),n.vadd(s.vadd(a).mult(o)),r.done(),n}}}),t.geometry("rectangle",function(e){var n={};return{init:function(t){var i=this;e.init.call(this,t),this.options.defaults(n),this.options.onChange(function(t){i.width=i.options.width||1,i.height=i.options.height||1}),this.options(t)},aabb:function(e){if(!e)return t.aabb(this.width,this.height);var n=t.scratchpad(),i=n.vector(),o=n.transform().setRotation(e||0),r=n.vector().set(1,0).rotateInv(o),s=n.vector().set(0,1).rotateInv(o),a=this.getFarthestHullPoint(r,i).proj(r),c=-this.getFarthestHullPoint(r.negate(),i).proj(r),l=this.getFarthestHullPoint(s,i).proj(s),h=-this.getFarthestHullPoint(s.negate(),i).proj(s);return n.done(),t.aabb(c,h,a,l)},getFarthestHullPoint:function(e,n){n=n||new t.vector;var i=e.x,o=e.y;return i=0===i?0:0>i?.5*-this.width:.5*this.width,o=0===o?0:0>o?.5*-this.height:.5*this.height,n.set(i,o)},getFarthestCorePoint:function(t,e,n){var i,o;return e=this.getFarthestHullPoint(t,e),i=e.x,o=e.y,e.x=0===i?0:0>i?i+n:i-n,e.y=0===o?0:0>o?o+n:o-n,e}}}),t.body("circle",function(e){var n={radius:1};return{init:function(i){e.init.call(this,i),i=t.util.extend({},n,i),this.geometry=t.geometry("circle",{radius:i.radius}),this.recalc()},recalc:function(){e.recalc.call(this),this.moi=this.mass*this.geometry.radius*this.geometry.radius/2}}}),t.body("compound",function(e){return{init:function(n){e.init.call(this,n),this.mass=0,this.moi=0,this.children=[],this.geometry=t.geometry("compound"),this.addChildren(n.children)},connect:function(t){if(this.mass<=0)throw"Can not add empty compound body to world."},addChild:function(t){return this.addChildren([t]),this},addChildren:function(e){var n,i,o,r=this,s=t.scratchpad(),a=s.vector().zero(),c=e&&e.length,l=0;if(!c)return s.done(this);for(o=0;c>o;o++)n=e[o],n._world&&n._world.remove(n),this.children.push(n),this.geometry.addChild(n.geometry,new t.vector(n.offset).rotate(n.state.angular.pos).vadd(n.state.pos),n.state.angular.pos),i=n.state.pos,a.add(i._[0]*n.mass,i._[1]*n.mass),l+=n.mass;return this.mass+=l,a.mult(1/this.mass),this.offset.vsub(a),this._world&&this._world.one("render",function(){r.view=null}),this.recalc(),s.done(this)},clear:function(){return this._aabb=null,this.moi=0,this.mass=0,this.offset.zero(),this.children=[],this.geometry.clear(),this},refreshGeometry:function(){this.geometry.clear();for(var e,n=0,i=this.children.length;i>n;n++)e=this.children[n],this.geometry.addChild(e.geometry,new t.vector(e.state.pos).vadd(e.offset),e.state.angular.pos);return this},recalc:function(){e.recalc.call(this);for(var t,n=0,i=0,o=this.children.length;o>i;i++)t=this.children[i],t.recalc(),n+=t.moi+t.mass*t.state.pos.normSq();return this.moi=n,this}}}),t.body("convex-polygon",function(e){var n={};return{init:function(i){e.init.call(this,i),i=t.util.extend({},n,i),this.geometry=t.geometry("convex-polygon",{vertices:i.vertices}),this.recalc()},recalc:function(){e.recalc.call(this),this.moi=t.geometry.getPolygonMOI(this.geometry.vertices)}}}),t.body("rectangle",function(e){var n={};return{init:function(i){e.init.call(this,i),i=t.util.extend({},n,i),this.geometry=t.geometry("rectangle",{width:i.width,height:i.height}),this.recalc()},recalc:function(){var t=this.geometry.width,n=this.geometry.height;e.recalc.call(this),this.moi=(t*t+n*n)*this.mass/12}}}),t.behavior("attractor",function(e){var n={pos:null,strength:1,order:2,max:!1,min:!1};return{init:function(i){var o=this;this._pos=new t.vector,e.init.call(this),this.options.defaults(n),this.options.onChange(function(t){o._maxDist=t.max===!1?1/0:t.max,o._minDist=t.min?t.min:10,o.position(t.pos)}),this.options(i)},position:function(t){var e=this;return t?(this._pos.clone(t),e):this._pos.values()},behave:function(e){for(var n,i,o,r=this.getTargets(),s=this.options.order,a=this.options.strength,c=this._minDist,l=this._maxDist,h=t.scratchpad(),u=h.vector(),d=0,p=r.length;p>d;d++)n=r[d],u.clone(this._pos),u.vsub(n.state.pos),i=u.norm(),i>c&&l>i&&(o=a/Math.pow(i,s),n.accelerate(u.normalize().mult(o)));h.done()}}}),t.behavior("body-collision-detection",function(e){var n=[],i=function(e,i){var o=t.util.pairHash(e.uid,i.uid),r=n[o];return r||(r=n[o]=function(t){var n=r.tA,o=r.tB,s=r.tmpv1,a=r.tmpv2;return r.useCore?(s=e.geometry.getFarthestCorePoint(t.rotateInv(n),s,r.marginA),a=i.geometry.getFarthestCorePoint(t.rotate(n).rotateInv(o).negate(),a,r.marginB)):(s=e.geometry.getFarthestHullPoint(t.rotateInv(n),s),a=i.geometry.getFarthestHullPoint(t.rotate(n).rotateInv(o).negate(),a)),s.vadd(e.offset).transform(n),a.vadd(i.offset).transform(o),t.negate().rotate(o),{a:s.values(),b:a.values(),pt:s.vsub(a).values()}},r.tA=new t.transform,r.tB=new t.transform,r.tmpv1=new t.vector,r.tmpv2=new t.vector),r.useCore=!1,r.margin=0,r.tA.setRotation(e.state.angular.pos).setTranslation(e.state.pos),r.tB.setRotation(i.state.angular.pos).setTranslation(i.state.pos),r.bodyA=e,r.bodyB=i,r},o=function(e,n){var o,r,s,a,c=t.scratchpad(),l=c.vector(),h=c.vector(),u=c.vector(),d=!1,p=e.aabb(),f=Math.min(p.hw,p.hh),v=n.aabb(),g=Math.min(v.hw,v.hh);if(s=i(e,n),l.clone(e.state.pos).vadd(e.getGlobalOffset(u)).vsub(n.state.pos).vsub(n.getGlobalOffset(u)),r=t.gjk(s,l,!0),r.overlap){for(d={bodyA:e,bodyB:n},a=.01*Math.min(f||1,g||1),s.useCore=!0,s.marginA=0,s.marginB=0;(r.overlap||0===r.distance)&&(s.marginA<f||s.marginB<g);)s.marginA<f&&(s.marginA+=a),s.marginB<g&&(s.marginB+=a),r=t.gjk(s,l);if(r.overlap||r.maxIterationsReached)return c.done(!1);if(o=s.marginA+s.marginB-r.distance,0>=o)return c.done(!1);d.overlap=o,d.norm=l.clone(r.closest.b).vsub(h.clone(r.closest.a)).normalize().values(),d.mtv=l.mult(o).values(),d.pos=l.clone(d.norm).mult(s.marginA).vadd(h.clone(r.closest.a)).vsub(e.state.pos).values()}return c.done(d)},r=function(e,n){var i,o=t.scratchpad(),r=o.vector(),s=o.vector(),a=!1;return r.clone(n.state.pos).vadd(n.getGlobalOffset(s)).vsub(e.state.pos).vsub(e.getGlobalOffset(s)),i=r.norm()-(e.geometry.radius+n.geometry.radius),r.equals(t.vector.zero)&&r.set(1,0),0>=i&&(a={bodyA:e,bodyB:n,norm:r.normalize().values(),mtv:r.mult(-i).values(),pos:r.mult(-e.geometry.radius/i).vadd(s).values(),overlap:-i}),o.done(a)},s=function c(e,n){if(!("static"!==e.treatment&&"kinematic"!==e.treatment||"static"!==n.treatment&&"kinematic"!==n.treatment))return!1;if("circle"===e.geometry.name&&"circle"===n.geometry.name)return r(e,n);if("compound"===e.geometry.name||"compound"===n.geometry.name){var i,s,a,l,h="compound"===e.geometry.name,u=h?e:n,d=h?n:e,p=[],f=t.scratchpad(),v=(f.vector(),f.vector()),g=d.aabb();for(a=0,l=u.children.length;l>a;a++){if(s=u.children[a],v.clone(s.state.pos),s.offset.vadd(v.vadd(u.offset).rotate(-s.state.angular.pos)),s.state.pos.clone(u.state.pos),s.state.angular.pos+=u.state.angular.pos,t.aabb.overlap(g,s.aabb()))if(i=c(d,s),i instanceof Array)for(var m,y=0,b=i.length;b>y;y++)m=i[y],m.bodyA===s?m.bodyA=u:m.bodyB=u,p.push(m);else i&&(i.bodyA===s?i.bodyA=u:i.bodyB=u,p.push(i));s.state.angular.pos-=u.state.angular.pos,s.offset.vsub(v),s.state.pos.clone(v.rotate(s.state.angular.pos).vsub(u.offset))}return f.done(p)}return o(e,n)},a={check:"collisions:candidates",channel:"collisions:detected"};return{init:function(t){e.init.call(this),this.options.defaults(a),this.options(t)},connect:function(t){this.options.check===!0?t.on("integrate:velocities",this.checkAll,this):t.on(this.options.check,this.check,this)},disconnect:function(t){this.options.check===!0?t.off("integrate:velocities",this.checkAll,this):t.off(this.options.check,this.check,this)},check:function(e){for(var n,i,o,r=e.candidates,a=this.getTargets(),c=[],l=this.prevContacts||{},h={},u=t.util.pairHash,d=0,p=r.length;p>d;++d)if(n=r[d],a===this._world._bodies||t.util.indexOf(a,n.bodyA)>-1&&t.util.indexOf(a,n.bodyB)>-1)if(i=s(n.bodyA,n.bodyB),i instanceof Array)for(var f,v=0,g=i.length;g>v;v++)f=i[v],f&&(o=u(n.bodyA.uid,n.bodyB.uid),h[o]=!0,f.collidedPreviously=l[o],c.push(f));else i&&(o=u(n.bodyA.uid,n.bodyB.uid),h[o]=!0,i.collidedPreviously=l[o],c.push(i));this.prevContacts=h,c.length&&this._world.emit(this.options.channel,{collisions:c})},checkAll:function(e){for(var n,i,o,r,a=this.getTargets(),c=(e.dt,[]),l=this.prevContacts||{},h={},u=t.util.pairHash,d=0,p=a.length;p>d;d++){n=a[d];for(var f=d+1;p>f;f++)if(i=a[f],o=s(n,i),o instanceof Array)for(var v,g=0,m=o.length;m>g;g++)v=o[g],v&&(r=u(n.uid,i.uid),h[r]=!0,v.collidedPreviously=l[r],c.push(v));else o&&(r=u(n.uid,i.uid),h[r]=!0,o.collidedPreviously=l[r],c.push(o))}this.prevContacts=h,c.length&&this._world.emit(this.options.channel,{collisions:c})}}}),t.behavior("body-impulse-response",function(e){function n(t){return t.uid}function i(t,e,n){var i,o;return o=e.norm(),i=o-t.proj(e),i=Math.max(0,Math.min(o,i)),0===o?n.zero():n.clone(e).mult(i/o),n}var o={check:"collisions:detected",mtvThreshold:1,bodyExtractDropoff:.5,forceWakeupAboveOverlapThreshold:!0};return{init:function(t){e.init.call(this),this.options.defaults(o),this.options(t),this._bodyList=[]},applyTo:!1,connect:function(t){t.on(this.options.check,this.respond,this)},disconnect:function(t){t.off(this.options.check,this.respond,this)},collideBodies:function(e,n,o,r,s,a){var c="static"===e.treatment||"kinematic"===e.treatment,l="static"===n.treatment||"kinematic"===n.treatment,h=t.scratchpad(),u=h.vector().clone(s);if(c&&l)return void h.done();var d,p,f,v,g=c?0:1/e.moi,m=l?0:1/n.moi,y=c?0:1/e.mass,b=l?0:1/n.mass,_=e.restitution*n.restitution,w=e.cof*n.cof,x=h.vector().clone(o),A=h.vector().clone(x).perp(),P=h.vector(),C=h.vector().clone(r),B=h.vector().clone(r).vadd(e.state.pos).vsub(n.state.pos),k=e.state.angular.vel,T=n.state.angular.vel,M=h.vector().clone(n.state.vel).vadd(P.clone(B).perp().mult(T)).vsub(e.state.vel).vsub(P.clone(C).perp().mult(k)),j=C.proj(x),O=C.proj(A),I=B.proj(x),F=B.proj(A),q=M.proj(x),z=M.proj(A);return a&&(c?(i(n._mtvTotal,u,P),n._mtvTotal.vadd(P)):l?(i(e._mtvTotal,u.negate(),P),e._mtvTotal.vadd(P),u.negate()):(v=.5,u.mult(v),i(n._mtvTotal,u,P),n._mtvTotal.vadd(P),u.clone(s).mult(v-1),i(e._mtvTotal,u,P),e._mtvTotal.vadd(P))),q>=0?void h.done():(g=g===1/0?0:g,m=m===1/0?0:m,d=-((1+_)*q)/(y+b+g*O*O+m*F*F),c?(n.state.vel.vadd(x.mult(d*b)),n.state.angular.vel-=d*m*F):l?(e.state.vel.vsub(x.mult(d*y)),e.state.angular.vel+=d*g*O):(n.state.vel.vadd(x.mult(d*b)),n.state.angular.vel-=d*m*F,e.state.vel.vsub(x.mult(y*n.mass)),e.state.angular.vel+=d*g*O),w&&z&&(f=Math.abs(z)/(y+b+g*j*j+m*I*I),p=0>z?-1:1,d=w*Math.abs(d),d=Math.min(d,f),d*=p,c?(n.state.vel.vsub(A.mult(d*b)),n.state.angular.vel-=d*m*I):l?(e.state.vel.vadd(A.mult(d*y)),e.state.angular.vel+=d*g*j):(n.state.vel.vsub(A.mult(d*b)),n.state.angular.vel-=d*m*I,e.state.vel.vadd(A.mult(y*n.mass)),e.state.angular.vel+=d*g*j)),e.sleep()&&e.sleepCheck(),n.sleep()&&n.sleepCheck(),void h.done())},_pushUniq:function(e){var i=t.util.sortedIndex(this._bodyList,e,n);this._bodyList[i]!==e&&this._bodyList.splice(i,0,e)},respond:function(e){var n,i,o,r,s=this,a=e.collisions;for(i=0,o=a.length;o>i;++i)n=a[i],this._pushUniq(n.bodyA),this._pushUniq(n.bodyB),n.bodyA._mtvTotal=n.bodyA._mtvTotal||new t.vector,n.bodyB._mtvTotal=n.bodyB._mtvTotal||new t.vector,n.bodyA._oldmtvTotal=n.bodyA._oldmtvTotal||new t.vector,n.bodyB._oldmtvTotal=n.bodyB._oldmtvTotal||new t.vector,s.collideBodies(n.bodyA,n.bodyB,n.norm,n.pos,n.mtv,n.collidedPreviously);for(i=0,o=this._bodyList.length;o>i;++i)r=this._bodyList.pop(),r._mtvTotal.normSq()<this.options.mtvThreshold?r._mtvTotal.mult(this.options.bodyExtractDropoff):this.options.forceWakeupAboveOverlapThreshold&&r.sleep(!1),r.state.pos.vadd(r._mtvTotal),r.state.old.pos.vadd(r._mtvTotal),r._oldmtvTotal.swap(r._mtvTotal),r._mtvTotal.zero()}}}),t.behavior("constant-acceleration",function(e){var n={acc:{x:0,y:4e-4}};return{init:function(i){e.init.call(this),this.options.defaults(n),this.options(i),this._acc=new t.vector,this.setAcceleration(this.options.acc),delete this.options.acc},setAcceleration:function(t){return this._acc.clone(t),this},behave:function(t){for(var e=this.getTargets(),n=0,i=e.length;i>n;++n)e[n].accelerate(this._acc)}}}),t.behavior("edge-collision-detection",function(e){var n=function(e,n,i){var o,r=e.aabb(),s=t.scratchpad(),a=e.getGlobalOffset(s.vector()),c=s.transform(),l=s.vector(),h=s.vector(),u=!1,d=[];return o=r.x+r.hw-n.max.x,o>=0&&(l.set(1,0).rotateInv(c.setRotation(e.state.angular.pos)),u={bodyA:e,bodyB:i,overlap:o,norm:{x:1,y:0},mtv:{x:o,y:0},pos:e.geometry.getFarthestHullPoint(l,h).rotate(c).vadd(a).values()},d.push(u)),o=r.y+r.hh-n.max.y,o>=0&&(l.set(0,1).rotateInv(c.setRotation(e.state.angular.pos)),u={bodyA:e,bodyB:i,overlap:o,norm:{x:0,y:1},mtv:{x:0,y:o},pos:e.geometry.getFarthestHullPoint(l,h).rotate(c).vadd(a).values()},d.push(u)),o=n.min.x-(r.x-r.hw),o>=0&&(l.set(-1,0).rotateInv(c.setRotation(e.state.angular.pos)),u={bodyA:e,bodyB:i,overlap:o,norm:{x:-1,y:0},mtv:{x:-o,y:0},pos:e.geometry.getFarthestHullPoint(l,h).rotate(c).vadd(a).values()},d.push(u)),o=n.min.y-(r.y-r.hh),o>=0&&(l.set(0,-1).rotateInv(c.setRotation(e.state.angular.pos)),u={bodyA:e,bodyB:i,overlap:o,norm:{x:0,y:-1},mtv:{x:0,y:-o},pos:e.geometry.getFarthestHullPoint(l,h).rotate(c).vadd(a).values()},d.push(u)),s.done(),d},i=function(t,e,i){return n(t,e,i)},o={aabb:null,restitution:.99,cof:1,channel:"collisions:detected"};return{init:function(n){e.init.call(this),this.options.defaults(o),this.options(n),this.setAABB(this.options.aabb),this.restitution=this.options.restitution,this.body=t.body("point",{treatment:"static",restitution:this.options.restitution,cof:this.options.cof})},setAABB:function(t){if(!t)throw"Error: aabb not set";return this._edges={min:{x:t.x-t.hw,y:t.y-t.hh},max:{x:t.x+t.hw,y:t.y+t.hh}},this},connect:function(t){t.on("integrate:positions",this.checkAll,this,2)},disconnect:function(t){t.off("integrate:positions",this.checkAll,this,2)},checkAll:function(e){for(var n,o,r,s=this.getTargets(),a=(e.dt,[]),c=this._edges,l=this.body,h=this.prevContacts||{},u={},d=t.util.pairHash,p=0,f=s.length;f>p;p++)if(n=s[p],"dynamic"===n.treatment&&(o=i(n,c,l))){r=d(n.uid,l.uid);for(var v=0,g=o.length;g>v;v++)u[r]=!0,o[v].collidedPreviously=h[r];a.push.apply(a,o)}this.prevContacts=u,a.length&&this._world.emit(this.options.channel,{collisions:a})}}}),t.behavior("interactive",function(t){return{}}),t.behavior("newtonian",function(e){var n={strength:1,max:!1,min:!1};return{init:function(t){var i=this;e.init.call(this),this.options.defaults(n),this.options.onChange(function(t){i._maxDistSq=t.max===!1?1/0:t.max*t.max,i._minDistSq=t.min?t.min*t.min:100*t.strength}),this.options(t)},calcPotential:function(e,n,i){var o,r,s,a=this.options.strength,c=this._minDistSq,l=this._maxDistSq;return s=i||new t.vector,s.clone(n).vsub(e),o=s.normSq(),o>c&&l>o?(r=a/o,s.normalize().mult(r)):s.zero()},behave:function(e){var n,i,o,r,s,a,c,l,h,u,d,p,f=this.getTargets(),v=t.scratchpad(),g=v.vector(),m=v.vector(),y=v.vector();for(c=0,u=f.length;u>c;c++)for(n=f[c],a=c+1;u>a;a++){if(i=f[a],"compound"===n.name?o=n:"compound"===i.name&&(o=i,i=n),o)if("compound"===i.name)for(l=0,d=o.children.length;d>l;l++)for(r=o.children[l],o.toWorldCoords(m.clone(r.state.pos).vadd(o.offset)),h=0,p=i.children.length;p>h;h++)s=i.children[h],i.toWorldCoords(y.clone(s.state.pos).vadd(i.offset)),this.calcPotential(m,y,g),o.accelerate(g.mult(s.mass)),i.accelerate(g.mult(r.mass/s.mass).negate());else for(l=0,d=o.children.length;d>l;l++)r=o.children[l],o.toWorldCoords(m.clone(r.state.pos).vadd(o.offset)),this.calcPotential(m,i.state.pos,g),o.accelerate(g.mult(i.mass)),i.accelerate(g.mult(r.mass/i.mass).negate());else this.calcPotential(n.state.pos,i.state.pos,g),n.accelerate(g.mult(i.mass)),i.accelerate(g.mult(n.mass/i.mass).negate());o=null}v.done()}}}),t.behavior("sweep-prune",function(e){var n=1,i=function(){return n++},o={x:0,y:1},r=2,s=t.util.pairHash;return{init:function(t){e.init.call(this),this.options.defaults({channel:"collisions:candidates"}),this.options(t),this.encounters=[],this.candidates=[],this.clear()},clear:function(){this.tracked=[],this.pairs=[],this.intervalLists=[];for(var t=0;r>t;++t)this.intervalLists[t]=[]},connect:function(t){t.on("add:body",this.trackBody,this),t.on("remove:body",this.untrackBody,this),t.on("integrate:positions",this.sweep,this,1);for(var e=t.getBodies(),n=0,i=e.length;i>n;++n)this.trackBody({body:e[n]})},disconnect:function(t){t.off("add:body",this.trackBody,this),t.off("remove:body",this.untrackBody,this),t.off("integrate:positions",this.sweep,this,1),this.clear()},broadPhase:function(){return this.updateIntervals(),this.sortIntervalLists(),this._world&&this._world.emit("sweep-prune:intervals",this.intervalLists),this.checkOverlaps()},sortIntervalLists:function(){for(var t,e,n,i,o,s,a,c,l,h=0;r>h;++h)for(t=this.intervalLists[h],n=0,e=t.length,l=h;++n<e;){for(o=t[n],s=o.val.get(l),i=n,a=t[i-1],c=a&&a.val.get(l);i>0&&(c>s||c===s&&a.type&&!o.type);)t[i]=a,i--,a=t[i-1],c=a&&a.val.get(l);t[i]=o}},getPair:function(t,e,n){var i=s(t.id,e.id);if(i===!1)return null;var o=this.pairs[i];if(!o){if(!n)return null;o=this.pairs[i]={bodyA:t.body,bodyB:e.body,flag:1}}return n&&(o.flag=1),o},checkOverlaps:function(){var e,n,i,s,a,c,l,h,u,d=1<<o.z+1<<o.y+1<<o.x+1,p=this.encounters,f=0,v=this.candidates;t.util.clearArray(p),t.util.clearArray(v);for(var g=0;r>g;++g)for(e=0===g,a=this.intervalLists[g],l=0,c=a.length;c>l;l++)if(s=a[l],n=s.tracker,s.type)for(h=f,h=f-1;h>=0;h--)i=p[h],i===n?(f-1>h?p[h]=p.pop():p.pop(),f--):(u=this.getPair(n,i,e),u&&u.flag<d&&(u.flag=u.flag<<g+1,u.flag===d&&v.push(u)));else f=p.push(n);return v},updateIntervals:function(){for(var t,e,n,i=this.tracked,o=i.length;--o>=0;)t=i[o],e=t.interval,n=t.body.aabb(),e.min.val.clone(n).sub(n.hw,n.hh),e.max.val.clone(n).add(n.hw,n.hh)},trackBody:function(e){var n=e.body,o={id:i(),body:n},s={min:{type:!1,val:new t.vector,tracker:o},max:{type:!0,val:new t.vector,tracker:o}};o.interval=s,this.tracked.push(o);for(var a=0;r>a;++a)this.intervalLists[a].push(s.min,s.max)},untrackBody:function(t){for(var e,n,i,o,s=t.body,a=this.tracked,c=0,l=a.length;l>c;++c)if(i=a[c],i.body===s){a.splice(c,1);for(var h=0;r>h;++h){o=0,e=this.intervalLists[h];for(var u=0,d=e.length;d>u;++u)if(n=e[u],n===i.interval.min||n===i.interval.max){if(e.splice(u,1),u--,l--,o>0)break;o++}}break}},sweep:function(t){var e,n=this;e=n.broadPhase(),e.length&&this._world.emit(this.options.channel,{candidates:e})}}}),t.behavior("verlet-constraints",function(e){var n=2*Math.PI,i={iterations:2};return{init:function(t){e.init.call(this),this.options.defaults(i),this.options(t),this._distanceConstraints=[],this._angleConstraints=[]},connect:function(t){var e=t.integrator();if(e&&e.name.indexOf("verlet")<0)throw'The rigid constraint manager needs a world with a "verlet" compatible integrator.';t.on("integrate:positions",this.resolve,this)},disconnect:function(t){t.off("integrate:positions",this.resolve,this)},drop:function(){return this._distanceConstraints=[],this._angleConstraints=[],this},distanceConstraint:function(e,n,i,o){var r;return e&&n?(r={id:t.util.uniqueId("dis-constraint"),type:"dis",bodyA:e,bodyB:n,stiffness:i||.5,targetLength:o||n.state.pos.dist(e.state.pos)},r.targetLengthSq=r.targetLength*r.targetLength,this._distanceConstraints.push(r),r):!1},angleConstraint:function(e,n,i,o,r){var s;return e&&n?(s={id:t.util.uniqueId("ang-constraint"),type:"ang",bodyA:e,bodyB:n,bodyC:i,stiffness:o||.5,targetAngle:r||n.state.pos.angle2(e.state.pos,i.state.pos)},this._angleConstraints.push(s),s):!1},remove:function(e){var n,i,o,r,s;if(o=t.util.isObject(e),i=o?e.type:e.substr(0,3),n="ang"===i?this._angleConstraints:this._distanceConstraints,o){for(r=0,s=n.length;s>r;++r)if(n[r]===e)return n.splice(r,1),this}else for(r=0,s=n.length;s>r;++r)if(n[r].id===e)return n.splice(r,1),this;return this},resolveAngleConstraints:function(e){for(var i,o,r,s,a=this._angleConstraints,c=t.scratchpad(),l=c.transform(),h=0,u=a.length;u>h;++h)i=a[h],o=i.bodyB.state.pos.angle2(i.bodyA.state.pos,i.bodyC.state.pos),r=o-i.targetAngle,r&&(r<=-Math.PI?r+=n:r>=Math.PI&&(r-=n),l.setTranslation(i.bodyB.state.pos),r*=-e*i.stiffness,"dynamic"===i.bodyA.treatment&&"dynamic"===i.bodyB.treatment&&"dynamic"===i.bodyC.treatment&&(s=1/(i.bodyA.mass+i.bodyB.mass+i.bodyC.mass)),"dynamic"===i.bodyA.treatment&&(o="dynamic"===i.bodyB.treatment&&"dynamic"===i.bodyC.treatment?r*(i.bodyB.mass+i.bodyC.mass)*s:"dynamic"!==i.bodyB.treatment?r*i.bodyC.mass/(i.bodyC.mass+i.bodyA.mass):r*i.bodyB.mass/(i.bodyB.mass+i.bodyA.mass),l.setRotation(o),i.bodyA.state.pos.translateInv(l),i.bodyA.state.pos.rotate(l),i.bodyA.state.pos.translate(l)),"dynamic"===i.bodyC.treatment&&(o="dynamic"===i.bodyA.treatment&&"dynamic"===i.bodyB.treatment?-r*(i.bodyB.mass+i.bodyA.mass)*s:"dynamic"!==i.bodyB.treatment?-r*i.bodyA.mass/(i.bodyC.mass+i.bodyA.mass):-r*i.bodyB.mass/(i.bodyB.mass+i.bodyC.mass),l.setRotation(o),i.bodyC.state.pos.translateInv(l),i.bodyC.state.pos.rotate(l),i.bodyC.state.pos.translate(l)),"dynamic"===i.bodyB.treatment&&(o="dynamic"===i.bodyA.treatment&&"dynamic"===i.bodyC.treatment?r*(i.bodyA.mass+i.bodyC.mass)*s:"dynamic"!==i.bodyA.treatment?r*i.bodyC.mass/(i.bodyC.mass+i.bodyB.mass):r*i.bodyA.mass/(i.bodyA.mass+i.bodyC.mass),l.setRotation(o).setTranslation(i.bodyA.state.pos),i.bodyB.state.pos.translateInv(l),i.bodyB.state.pos.rotate(l),i.bodyB.state.pos.translate(l),l.setTranslation(i.bodyC.state.pos),i.bodyB.state.pos.translateInv(l),i.bodyB.state.pos.rotateInv(l),i.bodyB.state.pos.translate(l)),i.bodyA.sleepCheck(),i.bodyB.sleepCheck(),i.bodyC.sleepCheck());c.done()},resolveDistanceConstraints:function(e){for(var n,i,o,r,s=this._distanceConstraints,a=t.scratchpad(),c=a.vector(),l=0,h=s.length;h>l;++l)n=s[l],c.clone(n.bodyB.state.pos).vsub(n.bodyA.state.pos),i=c.normSq()||1e-4*Math.random(),o=e*n.stiffness*(i-n.targetLengthSq)/i,c.mult(o),r="dynamic"!==n.bodyA.treatment||"dynamic"!==n.bodyB.treatment?1:n.bodyB.mass/(n.bodyA.mass+n.bodyB.mass),"dynamic"===n.bodyA.treatment&&("dynamic"===n.bodyB.treatment&&c.mult(r),n.bodyA.state.pos.vadd(c),"dynamic"===n.bodyB.treatment&&c.mult(1/r)),"dynamic"===n.bodyB.treatment&&("dynamic"===n.bodyA.treatment&&c.mult(1-r),n.bodyB.state.pos.vsub(c)),n.bodyA.sleepCheck(),n.bodyB.sleepCheck();a.done()},shuffleConstraints:function(){this._distanceConstraints=t.util.shuffle(this._distanceConstraints),this._angleConstraints=t.util.shuffle(this._angleConstraints)},resolve:function(){for(var t=this.options.iterations,e=1/t,n=0;t>n;n++)this.resolveDistanceConstraints(e),this.resolveAngleConstraints(e)},getConstraints:function(){return{distanceConstraints:[].concat(this._distanceConstraints),angleConstraints:[].concat(this._angleConstraints)}}}}),t.integrator("improved-euler",function(e){return{init:function(t){e.init.call(this,t)},integrateVelocities:function(t,e){for(var n,i=1-this.options.drag,o=null,r=0,s=t.length;s>r;++r)o=t[r],n=o.state,"static"===o.treatment||o.sleep(e)?(n.vel.zero(),n.acc.zero(),n.angular.vel=0,n.angular.acc=0):(n.old.vel.clone(n.vel),n.old.acc.clone(n.acc),n.vel.vadd(n.acc.mult(e)),i&&n.vel.mult(i),n.acc.zero(),n.old.angular.vel=n.angular.vel,n.angular.vel+=n.angular.acc*e,n.angular.acc=0)},integratePositions:function(e,n){for(var i,o=.5*n*n,r=null,s=t.scratchpad(),a=s.vector(),c=0,l=e.length;l>c;++c)r=e[c],i=r.state,"static"===r.treatment||r.sleep()||(i.old.pos.clone(i.pos),a.clone(i.old.vel),i.pos.vadd(a.mult(n)).vadd(i.old.acc.mult(o)),i.old.acc.zero(),i.old.angular.pos=i.angular.pos,i.angular.pos+=i.old.angular.vel*n+i.old.angular.acc*o,i.old.angular.acc=0);s.done()}}}),t.integrator("velocity-verlet-alt",function(e){return t.body.mixin({started:function(t){return void 0!==t&&(this._started=!0),!!this._started}}),{init:function(t){e.init.call(this,t)},integrateVelocities:function(t,e){for(var n,i=1-this.options.drag,o=null,r=0,s=t.length;s>r;++r)o=t[r],n=o.state,"static"!==o.treatment?(o.started()||(n.old.acc.clone(n.acc),n.old.acc.mult(e),n.old.vel.clone(n.vel).vsub(n.old.acc),n.old.acc.mult(1/e)),i&&n.vel.mult(i),n.vel.vadd(n.old.acc.vadd(n.acc).mult(.5*e)),o.started()||(n.old.angular.acc=n.angular.acc,n.old.angular.vel=n.angular.vel-n.old.angular.acc*e),n.angular.vel+=.5*(n.angular.acc+n.old.angular.acc)*e,n.angular.acc=0,o.started(!0)):(n.vel.zero(),n.acc.zero(),n.angular.vel=0,n.angular.acc=0)},integratePositions:function(t,e){for(var n,i=e*e,o=null,r=0,s=t.length;s>r;++r)o=t[r],n=o.state,"static"!==o.treatment&&(n.old.pos.clone(n.pos),n.old.vel.mult(e),n.old.acc.mult(.5*i),n.pos.vadd(n.old.vel).vadd(n.old.acc),n.old.vel.clone(n.vel),n.old.acc.clone(n.acc),n.acc.zero(),n.old.angular.pos=n.angular.pos,n.angular.pos+=n.angular.vel*e+.5*n.old.angular.acc*i,n.old.angular.vel=n.angular.vel,n.old.angular.acc=n.angular.acc,n.angular.acc=0)}}}),t.integrator("velocity-verlet",function(e){return t.body.mixin({started:function(t){return void 0!==t&&(this._started=!0),!!this._started}}),{init:function(t){e.init.call(this,t)},integrate:function(t,e){var n=this._world;return this.integratePositions(t,e),n&&n.emit("integrate:positions",{bodies:t,dt:e}),this.integrateVelocities(t,e),n&&n.emit("integrate:velocities",{bodies:t,dt:e}),this},integrateVelocities:function(t,e){for(var n,i=1-this.options.drag,o=null,r=0,s=t.length;s>r;++r)o=t[r],n=o.state,"static"===o.treatment||o.sleep()?(n.vel.zero(),n.acc.zero(),n.angular.vel=0,n.angular.acc=0):(i&&n.vel.mult(i),n.old.vel.clone(n.vel),n.vel.vadd(n.old.acc.vadd(n.acc).mult(.5*e)),n.old.acc.clone(n.acc),n.acc.zero(),n.old.angular.vel=n.angular.vel,n.old.angular.acc=n.angular.acc,n.angular.vel+=.5*(n.angular.acc+n.old.angular.acc)*e,n.angular.acc=0,o.started(!0))},integratePositions:function(t,e){for(var n,i=e*e,o=null,r=0,s=t.length;s>r;++r)o=t[r],n=o.state,"static"===o.treatment||o.sleep(e)||(o.started()||(n.old.acc.clone(n.acc),n.old.acc.mult(e),n.old.vel.clone(n.vel).vsub(n.old.acc),n.old.acc.mult(1/e)),n.old.pos.clone(n.pos),n.old.vel.mult(e),n.old.acc.mult(.5*i),n.pos.vadd(n.old.vel).vadd(n.old.acc),n.old.vel.mult(1/e),n.old.acc.mult(2/i),o.started()||(n.old.angular.acc=n.angular.acc,n.old.angular.vel=n.angular.vel-n.old.angular.acc*e),n.old.angular.pos=n.angular.pos,n.angular.pos+=n.angular.vel*e+.5*n.old.angular.acc*i)}}}),t});